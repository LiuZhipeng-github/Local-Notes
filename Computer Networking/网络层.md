# 网络层

> ## 一、概述
>
> 在网络中的每一台主机和路由器都有一个网络层部分，网络层能被分成两个相互作用的部分，即**数据平面**和**控制平面**。**数据平面的功能，即网络层中每台路由器的功能**，该数据平面功能决定到达路由器输入链路之一的数据报(即网络层分层)如何转发到该路由器的输出链路之一。**网络层的控制平面功能，即网络范围的逻辑**，该控制平面功能控制数据报沿着从源主机到目的主机的端到端路径中路由器之间的路由方式
>
> **报文段在网络中运输时，每台路由器的数据平面的主要作用是从其输入链路向其输出链路转发数据报，控制平面的主要作用是协调这些本地的路由器的转发动作，使得数据报沿着源和目的地主机之间的路由器路径最终进行端到端传送**
>
> 路由器具有截断的协议栈，即没有网络层以上的部分，因为路由器不运行应用层和运输层协议
>
> ### 1.转发和路由选择：数据平面和控制平面
>
> **转发**：当一个分组到达某路由器的一条输入链路时，该路由器必须将该分组移动到适当的输出链路，**转发是在网络层的数据平面中唯一，也是最重要的功能**
>
> **路由选择**：当分组从发送方流向接收方时，网络层必须决定这些分组所采用的路由或路径，计算这些路径的算法称为**路由选择算法**，**路由选择在网络层的控制平面中实现**
>
> 类比：
> 当X驾车从A到B的过程中，X经过的每个路口，立交桥可以看作进行了一次转发，X规划从A到B的过程，可以看作是路由选择
>
> 每台网络路由器中都有一个关键元素是它的**转发表**，路由器检查到达分组首部的一个或多个字段值，进而使用这些首部值在其转发表中索引，通过这中方法来转发分组，这些值对应存储在转发表中的值，指出了该分组将被转发的路由器的输出链路接口
>
> **控制平面：传统方法**：路由选择算法决定了插入该路由器转发表的内容，路由选择算法运行在每台路由器中，并且在每台路由器中都有转发和路由选择这两种功能。在一台路由器中的路由选择算法与在其它路由器中的路由选择算法通信，以计算出它的转发表的值
>
> 路由器中物理上存在的转发表的内容可以是人类直接配置的，进一步说明转发和路由选择功能的区别和不同。在这种情况下，不需要任何路由选择协议。但人工配置更容易出错，并且对于网络拓扑变化的影响比起路由选择协议更慢
>
> **控制平面：SDN方法**：路由器也可以物理上分离，即远程控制计算机和分发转发表以供每台路由器使用，路由选择设备仅执行转发，而远程控制器计算并分发转发表，远程控制器可能实现在具有高可靠性和冗余的远程数据中心，并可能由ISP或某些第三方的管理，这种控制平面方法是**SDN**，因为计算机转发表并于路由器交换的控制器是用软件实现的，故网络是‘软件定义’的
>
> ### 2.网络服务模型
>
> **网络服务模型**定义了分组在发送和接收端系统之间的端到端运输特性
>
> 网络层可能包含的服务：**确保交付**，**具有时延上界的确保交付**，**有序分组交付**，**确保最小带宽**，**安全性**
>
> 因特网的网络层提供了单一的服务，称为**尽力而为服务**，虽然对上述服务不保证，但因特网的尽力而为服务模型与适当带宽供给结合已经足够好，能用于大量的应用
>
> ## 2.路由器工作原理
>
> 网络层的转发功能，实际上是将分组从一台路由器的入链路传送到适当的出链路
>
> ![在这里插入图片描述](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzU0MTA5NA==,size_16,color_FFFFFF,t_70-20201121212024690.png)
> **输入端口**：它在路由器中执行终结入物理链路的物理层功能，还要与位于入链路远端的数据链路层交互来执行数据链路层功能，在输入端口还要执行查找功能。在输入端口，通过查询转发表决定路由器的输出端口，到达的分组通过路由器的交换结构转发到输出端口，控制分组(如携带路由选择协议信息的分组)从输入端口转发到路由选择处理器
>
> **交换结构**：交换结构将路由器的输入端口连接到它的输出端口，这种交换结构包含在路由器中，即它是一个网络路由器中的网络
>
> **输出端口**：输出端口存储从交换结构接收的分组，并通过执行必要的链路层和物理层功能在输出链路上传输这些分组
>
> **路由器的输入，输出端口和交换结构几乎都是硬件实现**
>
> **路由选择处理器**：路由选择处理器执行控制平面功能，在传统的路由器中，它执行路由选择协议，维护路由选择表与关联链路状态信息，并为该路由器计算装发表。在SDN路由器中，路由选择处理器负责与远程控制器通信，目的是接收由远程控制器计算的转发表项，并在该路由器的输入端口安装这些事项，还执行网络管理功能
>
> 分组转发需要面对的两种情况：**基于目的地转发**和**通用转发**
>
> ### 1、输入端口处理和基于目的地转发
>
> ![在这里插入图片描述](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzU0MTA5NA==,size_16,color_FFFFFF,t_70-20201121212026918.png)
>
> 输入端口的线路端接功能与链路层处理实现了用于各个输入链路的物理层和链路层。在输入端口中执行的查找对于路由器的运行是至关重要的，正是在这个地方，路由器使用转发表来查找输出的端口，使得新到达的分组能经过交换结构转发到该输出端口。转发表是由路由选择处理器计算更新的，或者转发表接收来自远程SDN控制器的内容
>
> ![在这里插入图片描述](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzU0MTA5NA==,size_16,color_FFFFFF,t_70-20201121212024693.png)
>
> 路由器用分组目的地址的**前缀**与该表中的表项进行匹配，如果存在一个匹配项，则路由器向与该匹配项相关的链路转发分组，当有多个匹配时，该路由器使用**最长前缀匹配规则**，即在该表中寻找最长的匹配项，并向与最长前缀匹配相关联的链路接口转发分组
>
> 一旦通过查找确定了某分组的输出端口，则该分组就能够发送进入交换结构。如果来自其它输入端口的分组正在使用交换结构，一个分组可能会在进入交换结构时被暂时阻塞，因此，一个被阻塞的分组必须要在输入端口处排队
>
> 尽管**查找**在输入端口处理可以认为是最重要的动作，但必须采取其它许多动作，1，必须出现物理层和链路层处理，2，必须检查分组的版本号，检验和以及寿命字段，3，必须更新用于网络管理的计数器
>
> ### 2、交换
>
> 交换结构位于一台路由器的核心部位，因为正是通过这种交换结构，分组才能实际地从一个输入端口交换(转发)到一个输出端口中
>
> 三种交换技术：(经内存交换，经互联网络交换，经总线交换)
>
> ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200818165312885.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzU0MTA5NA==,size_16,color_FFFFFF,t_70#pic_center)
>
> 经内存交换：
>
> 一个分组到达一个输入端口时，该端口会先通过中断方式向路由选择处理器发出信号。于是，该分组从输入端口处被复制到处理器内存中。路由选择处理器则从其首部中提取目的地址，在转发表中找出适合的输出端口，并将该分组复制到输出端口的缓存中。
>
> 经总线交换：
>
> 让输入输出端口为分组预先计划一个交换机内部标签，指示本地输出端口，使分组在总线上传送和传输到输出端口。该分组能由所有输出端口收到，但只有与该标签匹配的端口才能保存该分组。
>
> 经互联网交换：
>
> 每条垂直总线在交叉点与每条水平的总线交叉，交叉点通过交换结构控制器能够在任何时候开启和关闭。
>
> ### 3、输出端口处理
>
> ![在这里插入图片描述](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzU0MTA5NA==,size_16,color_FFFFFF,t_70-20201121212026223.png)
>
> 输出端口处理取出已经存放在输出端口内存中地分组并将其发送到输出链路上，这包括选择和取出排队地分组进行传输，执行所需地链路层和物理层传输功能
>
> ### 4、如何出现排队
>
> 在输入端口和输出端口处都可以形成分组队列，排队的位置和程度将取决于流量负载，交换结构的相对速率和线路速率，随着这些队列的增长，路由器的缓存空间最终会被耗尽，当无内存可用时就会出现**丢包**
>
> ### 5、分组调度
>
> 为了解决排队的分组如何确定次序经输出链路传输有三种调度方式
>
> **先进先出 FIFO**：FIFO也称先来先服务(FCFS)，用编号指示了分组到达的次序，利用FIFO规则，分组按照到达的相同次序离开
>
> **优先权排队**：在优先权排队规则下，到达输出链路的分组被分类放入输出队列中的优先权类，网络操作员可以配置一个队列，这样携带网络管理信息的分组(如，由源或目的TCP/UDP端口号所标识)获得超过用户流量的优先权。每个优先权类通常有自己的队列，当选择一个分组传输时，优先权排队规则将从队列为非空的最高优先权类中传输一个分组，在同一优先权类的分组之间的选择通常以FIFO方式完成
>
> **循环和加权公平排队**：在循环排队规则中，分组像使用优先权排队那样被分类，类之间不存在严格的服务优先权，循环调度器在这些类之间轮流提供服务
> 加权公平排队是一种通用形式的循环排队它已经广泛实现在路由器中

## 二、网际协议

> 网际协议(IP)，掌握IP编址就是掌握因特网的网络层
>
> ### 1. IPv4数据报格式
>
> 网络层分组称为数据报
> ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200818175023236.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzU0MTA5NA==,size_16,color_FFFFFF,t_70#pic_center)
> **版本号**：这4比特规定了数据报的IP版本协议，通过查看版本号，路由器能够确定如何解释IP数据报的剩余部分，不同的IP版本使用不同的数据报格式，新版本为IPv6
>
> **首部长度**：因为一个IPv4数据报可以包含一些可变数量的选项(这些选项包括在IPv4数据报首部中)，故需要用这4比特来确定IP数据报中的载荷(如数据报中被封装的运输层报文段)实际开始的地方
>
> **服务类型 TOS**：包含在IPv4首部中，以便使不同类型的IP数据报(如，一些特别要求低时延，高吞吐量或可靠性的数据报)能相互区分开
>
> **数据报长度**：这是IP数据报的总长度(首部加数据)，因为该字段长为16比特，所以IP数据报理论最大长度为65535字节
>
> **标识，标志，片偏移**：这三个字段与**IP分片**有关，新版本的IPv6不允许在路由器上对分组分片。
>
> **寿命 TTL**：寿命字段用来确保数据报不会永远(如由长时间的路由选择环路)在网络中循环。每当一台路由器处理数据报时，该字段的TTL减1，若TTL字段为0，则该数据报必须丢弃
>
> **协议**：该字段通常仅当一个IP数据报到达其最终目的地才有用，该字段值指示了IP数据报的数据部分应当交给哪个特定的运输层协议，如，值为6表明数据部分要交给TCP，而值为17表示数据要交给UDP。协议号是将网络层与运输层绑定到一起的粘合剂，而端口号是将运输层和应用层绑定到一起的粘合剂。
>
> **首部检验和**：首部检验和用于帮助路由器检测收到的IP数据报中的比特错误。如果数据报首部中携带的检验和与计算得到的检验和不一样，则检测出是个差错，路由器一般会丢弃检测出错误的数据报
>
> **源和目的地地址**：当某源生成一个数据报时，它在源IP字段中插入它的IP地址，在目的IP地址中插入其最终目的地地址，通常源主机通过DNS查找来决定目的地址
>
> **选项**：选项字段允许IP地址首部被扩展，首部选项意为着很少使用，在IPv6中已经去掉了IP选项
>
> **数据(有效载荷)**：这是数据报存在的首要理由，在大多数情况下，IP数据报中的数据字段包含要交付给目的地的运输层报文段(TCP/UDP)，数据字段也可以承载其它类型的数据，如ICMP报文段
>
> 注意：一个IP数据报有总长为20字节的首部（假设无选项）。如果数据报承载一个TCP报文，则每一个数据报共承载了总长为40字节的首部以及应用层报文。
>
> ### 2.IPv4数据报分片
>
> 并不是所有链路层协议都能承载相同长度的网络层分组，由的协议能承载大数据报，而有的协议只能承载小分组，一个链路层帧能承载的最大数据量叫作**最大传送单元 MTU**，故链路层协议的MTU严格地限制着IP数据报的长度。对IP数据报长度具有严格限制并不是主要问题，问题在于在发送方与目的地路径上的每段链路可能使用不同的链路层协议，且每种协议使用不同的MTU
>
> 如何将一个过大的IP分组挤进链路层帧的有效载荷字段呢？解决该问题的方法是将IP数据报中的数据分成两个或更多较小的IP数据报，用单独的链路层帧封装这些较小的IP数据报，然后通过输出链路发送给这些帧，每个这些较小的数据报称为**片**
>
> 片在其到达目的地运输层以前需要重新组装，TCP与UDP的确都希望从网络层收到完整的，未分片的报文。但为了不影响路由器的性能，IPv4将数据报的重新组装工作放到端系统中，而不是放在网络路由器中
>
> IPv4的设计者将**标识**，**标志**，**偏移字段**放在IP数据报的首部中用来处理有关数据报分片的问题
>
> 标识：发送主机通常将它发送的每个数据报标识加1。
>
> 标志：只有最后一片的标志设为0，而其他所有分片的标志比特设置为1。
>
> 偏移字段：使用偏移字段指定该分片应该放在初始IP数据报的哪个位置。
>
> ### 3.IPv4编址
>
> IP要求每台主机和路由器接口拥有自己的IP地址，因此可以说，一个IP地址与一个接口相关联，而不是与包括该接口的主机或路由器相关联
>
> 每个IP地址长度为32比特，因此共有2^32个可能的IP地址，这些地址通常按所谓的**点分十进制记法**书写，即地址中每个字节用它的十进制形式书写，各字节间以句点隔开，如(193.32.216.9)的二进制记法为(11000001 00100000 11011000 00001001)。在全球因特网中的每台主机和路由器上的每个接口，都必须有一个全球唯一的IP地址，且这些地址不能随意地自由选择，一个接口地IP地址的一部分需要由其连接的子网来决定
>
> ![在这里插入图片描述](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzU0MTA5NA==,size_16,color_FFFFFF,t_70-20201121212026929.png)
> 上图从233.1.1.1到233.1.1.4，这四个接口通过一个并不包含路由器的网络互联起来，该网络可能由一个以太网LAN互联，在此情况下，这些接口将通过一台以太网交换机互联，或者通过一个无线接入点互联，我们将这种无路由器连接的这些主机的网络表示为一朵云
>
> 互联这三个主机接口与1个路由器接口的网络称为一个**子网**，IP编址为这个子网分配一个地址233.1.1.0/24，其中/24记法，有时称为**子网掩码**，指示32比特中的最左侧开始的24比特定义了子网地址
>
> 一个子网的IP定义并不局限于连接多台主机到一个路由器接口的以太网段。为了确定子网，分开主机和路由器的每个接口，产生几个隔离的网络岛，使用接口端接这些隔离的网络的端点，这些隔离的网络中的每一个都叫一个子网
>
> 一个具有多个以太网段和点对点链路的组织将具有多个子网，在给定子网上的所有设备都具有相同的子网地址。因特网的地址分配策略被称为**无类别域间路由选择 CIDR**，CIDR将子网寻址的概念一般化了。当使用子网寻址时，32比特的IP地址被划分成两部分，并且也具有点分十进制数形式，a.b.c.d/x，x指示了地址的第一部分中的比特数
>
> 形式为a.b.c.d/x的地址的x最高比特构成了IP地址的网络部分，并且经常被称为该地址的**前缀**，一个组织通常被分配一块连续的地址，即具有相同的前缀的一段地址。在这种情况下，该组织内部的设备的IP地址将共享共同的前缀
>
> 一个地址的剩余32-x比特可以认为是用于区分该组织内部设备的，其中的所有设备具有相同的网络前缀。在CIDR被采用前，IP地址的网络部分被限制长度为8，16，或24比特，这是一种**分类编址**，这是因为具有8，16，24，比特子网地址的子网分别被称为A，B，C类网络。IP广播地址255.255.255.255，当一台主机发出一个目的地址为255.255.255.255的数据报时，该报文会交付给同一个网络中的所有主机
>
> **获取一块地址**：为了获取一块IP地址用于一个组织的子网内，可以先于ISP联系，ISP可能会从已分给它的更大的地址块中提供一些地址。
> IP地址由**因特网名字和编号分配机构 ICANN**管理，ICANN的作用不仅是分配IP地址，还管理DNS根服务器，分配域名与解决域名纷争
>
> **获取主机地址：动态主机配置协议**：系统管理员通常手工配置路由器的IP地址。主机地址也能手动配置，但这项任务目前更多的是使用**动态主机配置协议 DHCP**来完成，DHCP允许主机自动获取(被分配)一个IP地址。网络管理员能够配置DHCP，以使某给定主机每次与网络相连时能得到一个相同的IP地址，或者某主机被分配一个**临时IP地址**，每次与网络连接时该地址也许是不同地。除了主机IP地址分配外，DHCP还允许一台主机得知其它信息，例如它的子网掩码，它的第一起跳路由器(默认网关)与它的本地DNS服务器的地址
> 由于DHCP具有将主机连接进一个网络的网络相关方面的自动能力，故它又被称为**即插即用协议**或**零配置协议**。DHCP是一个客户-服务器协议，客户通常是新到达的主机，它要获得包括自身使用的IP地址在内的网络配置信息。在最简单的场合下，每个子网将具有一台DHCP服务器，如果某子网中没有服务器，则需要一个DHCP中继代理，这个代理知道用于该网络的DHCP服务器的地址
>
> DHCP协议是一个4个步骤的过程：
> 1，DHCP服务器发现
> 2，DHCP服务器提供
> 3，DHCP请求
> 4，DHCP ACK
> 一旦客户收到了DHCP ACK后，交互便完成了，并且客户能在租用期内使用DHCP分配的IP地址。但从移动性角度看，DHCP存在非常严重的缺陷，因为每当节点连接到一个新子网，要从DHCP得到一个新的IP地址，当一个移动节点在子网间移动时，就不能维持与远程应用之间的TCP连接
>
> ### 4.网络地址转换
>
> NAT使能路由器中的NAT转换表进行网络地址转换
>
> NAT使能路由器对外部世界来说甚至不像一个路由器。相反NAT路由器对外界的 行为就如同一个具有单一IP地址的单一设备。所有离开家庭路由器流向更大的因特网的报文都拥有一个源IP地址，且所有进入家庭的报文都拥有同一个目的地址。从本质上讲，NAT使能路由器对外界隐藏了家庭网络的细节。
>
> 这里应该有一张图！！！！！！
>
> ### 5.IPv6
>
> 由于新的子网和IP节点以惊人的增长率连到因特网上(并被分配唯一的IP地址)，32比特的IP地址空间将被耗尽，为了应对这种大IP地址空间的需求，开发出了一种新的IP协议，即IPv6
>
> **IPv6数据报格式**：
> ![在这里插入图片描述](%E7%BD%91%E7%BB%9C%E5%B1%82.assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzU0MTA5NA==,size_16,color_FFFFFF,t_70-20201121212026199.png)
> **扩大的地址容量**：IPv6将IP地址长度从32比特增加到128比特，确保了全世界将不会用尽IP地址
>
> **简化高效的40字节首部**：使用40字节定长首部允许路由器更快的处理IP数据报
>
> **流标签**：IPv6有一个难以捉摸的**流**定义，该字段可用于‘给属于特殊流的分组加上标签，这些特殊流是发送方要求进行特殊处理的流，如一种非默认服务质量或需要实时服务的流’，
>
> **版本**：该4个比特字段用于表示IP版本号
>
> **流量类型**：该8比特字段与IPv4中的TOS字段含义相似
>
> **流标签**：该20比特的字段用于识别一条数据报的流，能够对一条流中某些数据报给出优先权
>
> **有效载荷长度**：该16比特值作为一个无符号整数，给出了IPv6数据报中跟在定长的40字节数据报首部后面的字节数量
>
> **下一个首部**：该字段标识数据报中的内容(数据字段)需要交付给哪个协议(TCP/UDP)
>
> **跳限制**：转发数据报的每台路由器将对该字段的内容减1，如果跳限制计数达到0，则丢弃该数据报
>
> **源地址和目的地址**
>
> **数据**：这是IPv6数据报的有效载荷部分，当数据报到达目的地时，该有效载荷就从IP数据报中移出，并交给在下一个首部字段中指定的协议处理
>
> 注意：IPv6数据报去掉了IPv4数据报中的 分片/重新组装，首部检验和，选项
>
> ###  6.从IPv4到IPv6：
>
> 基于IPv4的公共因特网如何迁移到IPv6？虽然IPv6使能系统可做成向后兼容，即能发送，路由和接收IPv4数据报，但已部署的具有IPv4能力的系统却无法处理IPv6的数据报
>
> 在实践中已经取得广泛应用的IPv4到IPv6迁移的方法包括**建隧道**，建隧道依据的基本思想如下：将两台IPv6路由器中间的IPv4路由器的集合称为一个隧道，借助于隧道，在隧道发送端的IPv6节点可将整个IPv6数据报放到一个IPv4数据报的有效载荷中，通过隧道的传输运送到另一端的IPv6路由器，隧道接收端的IPv6路由器接收它并识别处理。

> 转发表和流表计算，维护，安装的两种方法：
> **每路由器控制**：在每路由器中运行一种路由选择算法的情况，每台路由器中都包含转发和路由选择功能。每台路由器都有一个路由选择组件，用于与其它路由器中的路由选择组件通信，以计算其转发表的值
>
> **逻辑集中式控制**：逻辑集中式控制器计算并分发转发表以供每台路由器使用。该控制器经一种定义良好的协议与每台路由器中的一个**控制代理 CA**进行交互，以配置和管理该路由器的转发表。CA一般具有最少的功能，其任务是与控制器通信并且按控制器命令行事
> ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200819163653947.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzU0MTA5NA==,size_16,color_FFFFFF,t_70#pic_center)
> 逻辑集中式控制意味着就像路由器控制服务位于单一的集中服务点那样获取它们，即使该服务器出于容错和性能扩展的原因，很可能经由多个服务器实现。SDN采用了逻辑集中控制器的概念

## 六、路由选择算法

> **路由选择算法**：其目的是从发送方到接收方的过程中确定一条通过路由器网络的好的路径(等价于路由)。通常，一条好的路径指具有最低开销的路径。无论网络控制平面采用每路由器控制方法，还是采用逻辑集中式控制方法，必定总是存在一条定义良好的一连串路由器，使得分组从发送主机到接收主机跨越网络传输
>
> ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200819164445817.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzU0MTA5NA==,size_16,color_FFFFFF,t_70#pic_center)
> 一条边的开销可以反映出对应链路的物理长度(越洋链路比陆地链路的开销高)，它的链路速度，或与该链路相关金钱上的开销。
> 用c(x,y)表示x到y之间的开销，给定任意两个节点，通常这两个节点间有许多路径，每条路径都有一个开销，这些路径中的一条或多条是**最低开销路径**，即最低开销路径问题就是找出源和目的地之间具有最低开销的一条路，最低开销路径也就是**最短路径**，即源到目的地之间有最少链路数量的路径
>
> 路由选择算法的一种分类是根据算法是集中式还是分散式划分：
> **集中式路由选择算法**：用完整的，全局性的网络知识计算出从源到目的地之间的最低开销路径。该算法以所有节点之间的连通性以及所有链路的开销为输入，要求在开始计算前，要以某种方式获得需要的信息。集中式路由选择算法具有关于连通性和链路开销方面的完整信息。具有全局状态信息的算法常被称为**链路状态算法 LS**，因为该算法需要知道网络中每条链路的开销
>
> **分散式路由算法**：路由器以迭代，分布式的方式计算出最低开销路径，没有节点拥有关于网络链路开销的完整信息。每个节点仅有与其直接相连的链路的开销知识即可开始工作。通过迭代计算过程以及相邻节点的信息交换，一个节点逐渐计算出到达某目的节点或一组目的节点的最低开销路径。分散式路由算法中的**距离向量算法 DV**是重点
>
> 路由选择算法的第二种分类方式根据算法是动态还是静态：
> **静态路由选择算法**：路由随时间的变化非常缓慢，通常是人工进行调整(如人为手工编辑一条链路开销)
>
> **动态路由选择算法**：随着网络流量负载或拓扑发生变化而改变路由选择路径。虽然动态算法易于对网络的变化做出反应，但也更容易受诸如路由循环，路由震荡之类问题的影响
>
> 路由选择算法的第三种分类方式根据它是负载敏感还是负载迟钝：
> **负载敏感算法**：链路开销会动态地变化以反映出底层链路地当前拥塞水平。如果当前拥塞地一条链路与高开销相联系，则路由选择算法趋向于绕开该拥塞链路来选择路由
>
> **负载迟钝算法**：当今地路由选择算法都是负载迟钝地，因为某条链路的开销不明确地反应当前或最近的拥塞水平
>
> ### 1、 链路状态路由选择算法
>
> 在链路状态算法中，网络拓扑和所有的链路开销都是已知的，也就是说也用作LS算法的输入。实践中这是通过让每个节点向网络中所有其它节点广播链路状态分组来完成的，其中每个链路状态分组包含它所连接的链路的标识和开销，由**链路状态广播**完成。节点广播的结果是所有节点都具有该网络的统一，完整的视图。于是每个节点都能像其它节点一样，运行LS算法并计算出低开销路径集合
>
> LS算法可以由迪杰斯特拉算法实现，它计算从某节点到网络中所有其它节点的最低开销路径。迪杰斯特拉算法是迭代算法，其性质是经算法的第k次迭代后，可知道到k个目的节点的最低开销路径
>
> https://zhuanlan.zhihu.com/p/40338107  dijkstra算法
>
> ### 2、 距离向量路由选择算法
>
> 距离向量算法是一种迭代的，异步的，自我终止的，分布式的算法。说它是迭代的，由于它在计算时，一直持续到邻居之间无更多信息要交换为止。说它是异步的，由于它不要求所有节点相互之间步伐一致的操作。说它是自我终止的，由于其不需要应该停止的信号就可以自己停下。说它是分布式的，因为每个节点都要从一个或者多个直接相连邻居接收某些信息
>
> 节点具有的唯一信息是它到直接相连的邻居的链路开销和它从这些邻居接收到的信息，每个节点等待来自任何邻居的更新，当接收一个更新时计算它的新距离向量并向它的邻居分布其距离向量。DV算法被用于众多路由器选择协议中，包括因特网的RIP，BGP，ISO IDRP等
>
> https://blog.csdn.net/u013007900/article/details/45565389 距离矢量路由算法

## 七、OSPF

> 从所有路由器执行相同的路由选择算法以计算穿越整个网络的路由选择路径的意义上来说，一台路由器很难同另一台路由器区别开。在实践中，该模型和这种一组执行同样路由选择算法的同质路由器的集合的观点有一点简单化，有如下两个重要原因：
> 1，**规模**，随着路由器的数目增多，涉及路由选择信息的通信，计算和存储的开销将高的不可实现。在如此大量的路由器中迭代的距离向量算法将肯定永远无法收敛，必须采取一些措施以减少像因特网这种大型网路中的路由计算的复杂性
>
> 2，**管理自治**，因特网是ISP网络，其中每个ISP都有它自己的路由器网络，ISP通常希望按自己的意愿运行路由器(在自己的网络中运行它所选择的某种算法，或对外隐藏其网络内部组织面貌)，一个组织应当能够按自己的愿望运行和管理网络，还要将其网络与其它外部网络连接起来
>
> 这两个问题都可以通过将路由器组织进**自治系统 AS**来解决，其中每个AS由一组通常处在相同管理下的路由器组成，通常在一个ISP中的路由器以及互联它们的链路构成一个AS。一个自治系统由其全局唯一的AS号所标识，AS号由ICANN区域注册机构分配
>
> 在相同AS中的路由器都运行相同的路由选择算法并且有彼此的信息，在一个自治系统内运行的路由选择算法叫作**自治系统内部路由选择协议**
>
> **开放最短路优先 OSPF**：OSPF路由选择及其关系密切的协议IS-IS都被广泛应用于因特网的AS内部路由选择。OSPF中的O指open该路由选择协议规范是公众可用的
>
> OSPF是一种链路状态协议，它使用洪泛链路状态信息和迪杰斯特拉算法。使用OSPF，一台路由器构建了一副关于整个自治系统的完整拓扑图，于是每台路由器在本地运行迪杰斯特拉算法，以确定一个以自身为根节点到所有子网的最短路径树。各条链路开销是由网络管理员配置的
>
> 使用OSPF时，路由器向自治系统内的所有其它路由器广播路由信息，而不仅仅是向其相邻路由器广播，每当一条链路的状态发生变化时(开销的变化/中断状态的变化)，路由器就会广播链路状态信息。即使链路状态未发生改变，它也要周期性地广播链路状态
>
> OSPF的优点：1，**安全**，能够鉴别OSPF路由器之间的交换(如链路状态更新)，使用鉴别，仅有受信任的路由器能参与一个AS的OSPF协议。2，**多条相同开销的路径**，当到达某目的地多条路径具有相同的开销时，OSPF允许使用多条路径,即当存在多条相等开销的路径时，无须仅选择单一的路径承载全部的流量。3，**对单播与多播路由选择的综合支持**。4，**支持在单个AS中的层次结构**，一个OSPF自治系统能够层次化的配置多个区域，每个区域都运行自己的OSPF链路状态路由选择算法，区域内的每台路由器都向该区域内的所有其它路由器广播其链路状态

## 八、BGP

> OSPF是一个AS内部路由选择协议，当在相同AS内的源和目的地之间进行多个分组时，分组遵循的路径完全由AS内路由选择协议所决定。然而，当分组跨越多个AS进行路由时，比如从A市某用户的智能手机到位于B市的数据中心，我们需要一个**自治系统间路由协议**
>
> 因为AS路由间路由选择协议涉及到多个AS之间的协调，所以AS通信必须运行相同的AS间路由选择协议。在因特网中，所有的AS运行相同的AS间路由选择协议，称为**边界网关协议 BGP**，BGP是一种分布式和异步的协议，BGP协议将成千的ISP粘合起来
>
> ### 1、BGP的作用
>
> 对于位于相同AS中的目的地而言，在路由器转发表中的表项由AS内部路由选择协议所决定，而BGP处理位于不同AS间的路由选择
> 在BGP中，分组并不是路由到一个特定的目的地址，相反是路由到CDIR的前缀，其中每个前缀表示一个子网或一个子网的集合
>
> 作为一种AS间的路由选择协议，BGP为每台路由器提供了一种完成以下任务的手段：
> 1，**从邻居AS获得前缀的可表达信息**：BGP允许每个子网向因特网的其余部分通告它的存在，BGP确保在因特网中的所有AS知道该子网。如果没有BGP的话，每个子网将是隔离的孤岛，即它们是孤独的存在，不为因特网其余部分所知或所达
> 2，**确定到该前缀的‘最好的’路由**：一台路由器可能知道两条或更多条到特定前缀的不同路由，为了确定最好的路由，该路由器将本地运行一个BGP路由选择过程

### 2 、通告BGP路由信息

> 路由器分为**网关路由器**和**内部路由器**，网关路由器是一台位于AS边缘的路由器，它直接连接到其它AS中的一台或多台路由器。内部路由器仅连接在它自己AS中的主机和路由器
>
> 在BGP中，每对路由器通过使用179端口的半永久TCP连接交换路由选择信息，每条直接连接以及所有通过该连接发送的BGP报文，称为**BGP连接**。此外，跨越两个AS的BGP连接称为**外部BGP eBGP**，而在相同AS中的两台路由器之间存在的BGP会话称为**内部BGP iBGP**

### 3 、确定最好的路由

> 引入几个BGP术语，1，当路由器通过BGP连接通告前缀时，它在前缀中包括一些**BGP属性**。用BGP术语说，前缀及其属性称为**路由**。两个较为重要的属性是 **AS-PATH** 和 **NEXT-HOP**
> AS-PATH：包含了通告已经通过的AS的列表，且BGP路由器还是用了AS-PATH属性来检测和防止通告环路，特别是，如果一台路由器在路径列表中看到包含了它自己的AS，它将拒绝该通告
> NEXT-HOP：是AS-PATH起始的路由器接口的IP地址
>
> **热土豆路由选择**：使用热土豆路由选择，从所有可能的路由中选择的路由到开始该路由的NEXT-HOP路由器具有最小开销。分组被类比为烫手的热土豆，因为它烫手，要尽可能快地将它传给下一个人(另一个AS)。热土豆路由选择是自私的算法，即它试图减小在它自己AS中的开销，而忽略在其AS外的端到端开销的其它部分。注意到使用热土豆选择，对于在相同AS中的两台路由器，可能对相同的前缀选择两条不同的AS路径
>
> **路由器选择算法**：在实践中，BGP使用了一种比热土豆路由更复杂但却结合了其特点的算法。对于任何给定的目的地前缀，进入BGP的路由选择算法的输入是到某前缀的所有路由的集合，该前缀是已被路由器学习和接受的。如果仅有一条这样的路由，BGP则显然选择该路由。
>
> 如果到相同的前缀有两条或多条路由，则顺序地调用下列消除规则直到余下一条路由：
> 1，路由被指派一个**本地偏好**值作为其属性之一，它完全取决于AS的网络管理员，具有本地偏好值的路由将被选择
> 2，从余下的路由中(所有都具有相同的最高本地偏好值)，将选择具有有最短AS-PATH的路由
> 3，从余下的路由中(所有具有相同的最高本地偏好值和相同的AS-PATH长度)，使用热土豆路由选择，即选择具有最靠近NEXT-HOP路由器的路由
> 4，如果仍留下多条路由，该路由器使用BGP标识符来选择路由
>
> ###  4 、IP任播
>
> 除了作为因特网的AS间路由选择协议外，BGP还常用于IP任播服务，该服务常用于DNS中。如一个CDN能够更换位于不同国家，不同服务器上的视频和其它对象。类似地，DNS系统能够在遍及全世界的DNS服务器上复制DNS记录。当一个用户要访问该复制的内容，可以将用户指向具有该复制内容的‘最近的’服务器。
>
> 当该客户想向某个IP地址发送一个请求时，因特网路由器则向哪个‘最近的’服务器转发该请求分组，最近的服务器是由BGP路由选择算法所定义的
> 实践中CDN通常不使用IP任播，因为BGP路由选择变化能够导致相同的TCP连接发送不同实例。但IP任播被DNS广泛应用于DNS请求指向最近的根DNS服务器
>
> ### 5 、路由选择策略
>
> 当某路由器选择到目的地的一条路由时，AS路由选择策略能够胜过所有其它考虑，例如最短AS路径或热土豆路由选择。在路由选择算法中，实际上首先根据本地偏好值选择路由，本地偏好值由本地AS的策略所决定

## 九、SDN控制平面

> SDN控制平面，即控制分组在网络的SDN使能设备中转发的网络范围逻辑
>
> ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200820171003411.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzU0MTA5NA==,size_16,color_FFFFFF,t_70#pic_center)
>
> SDN体系结构具有四个关键特征：
> 1，**基于流的转发**：SDN控制的交换机的分组转发工作，能够基于运输层，网络层或链路层首部中任意数量的首部字段值进行。传统方法中IP数据报的转发仅依据数据报的目的IP地址进行。SDN控制平面的工作是计算，管理和安装所有网络交换机中的流表项
>
> 2，**数据平面与控制平面分离**：数据平面由网络交换机组成，交换机是简单且快速的设备，该设备在它们的流表中执行“匹配加动作”的规则。控制平面由服务器以及决定和管理交换机流表的软件组成
>
> 3，**网络控制功能：位于数据平面交换机外部**：SDN中的S代表软件，这个软件在服务器上执行，该服务器与网络交换机分开且远离。控制平面自身由两个平面组件组成：一个SDN控制器或网络操作系统，以及若干网络控制应用程序。控制器维护准确的网络状态信息(如远程链路，交换机和主机的状态)为运行在控制平面的网络控制应用程序提供这些信息，提供方法，这些应用程序通过这些方法能够监视，编程和控制下面的网络设备
>
> 4，**可编程的网络**：通过运行在控制平面中的网络控制应用程序，该网络是可编程的。这些应用程序代表了SDN控制平面的‘智力’，使用了由SDN控制器提供的API来定义和控制网络设备中的数据平面
>
> SDN表示了一种意义重大的网络功能的分类，即数据平面交换机，SDN控制器和网络控制应用程序是分离的实体，该实体可以由不同的厂商和组织机构提供
>
> ## 5.5.1 SDN控制器和SDN网络控制应用程序
>
> SDN控制平面大体划分为两个部分，即SDN控制器和SDN网络控制应用程序
>
> 控制器的功能可大体组织为3个层次：
> 1，**通信层**：SDN控制器和受控网络设备之间的通信。如果SDN控制器要控制远程的SDN使能的交换价，主机或其它设备的运行，需要一个协议来传送控制器与这些设备之间的信息。此外，设备还需要能向控制器传递本地观察到的事件(如一个设备刚刚加入了网络)这些事件向SDN控制器提供该网络状态的最新视图。这个协议构成了控制器体系结构的最底层。
> OpenFlow它是一种提供这种通信功能的特定协议，OpenFlow在大多数SDN控制器中得到了实现
>
> 2，**网络范围状态管理层**：由SDN控制平面所做出的最终控制决定(如配置所有交换机的流表以取得所希望的端到端转发，实现负载均衡，或实现一种特定防火墙)，将要求控制器具有相关网络的主机，链路，交换机和其它SDN控制设备的最新状态信息
>
> 3，**对于网络控制程序层的接口**：API允许网络控制层应用在状态管理层之间读/写网络状态和流表。当状态改变事件出现时，应用程序能够注册进行通告
>
> SDN控制器被认为是逻辑上集中的，即该控制器可以被外部视为一个单一，整体的服务，然而由于故障容忍，高可用性或性能方面的问题，在实践中这些服务和用于保持状态信息的数据库一般通过分布式服务器集合实现
>
> ## 5.5.2 OpenFlow协议
>
> OpenFlow协议运行在SDN控制器和SDN控制的交换机或其它OpenFlow API的设备之间。OpenFlow协议运行在TCP之上，使用6653的默认端口号，从控制器到受控交换机流动的重要报文报有：
> 配置，修改状态，读状态，发送分组，流删除，端口状态，分组入
>
> ## 5.5.3 数据平面和控制平面交互的例子
>
> ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200820180925823.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzU0MTA5NA==,size_16,color_FFFFFF,t_70#pic_center)
>
> SDN使能的ISP能够容易地将最低开销路径地路由选择转变为更加定制的路由选择方法。因为控制器能随心所欲地定制流表，因此能够实现它喜欢的任何形式的转发，即只是通过改变它的应用控制软件

## 十、ICMP协议

> **因特网控制报文协议 ICMP**：被主机和路由器用来彼此沟通网络层的信息ICMP最典型的用途是差错报告。ICMP常被认为是IP的一部分，但从体系结构上讲它位于IP之上，因为ICMP报文就是承载在IP分组中的。这就是说，ICMP报文是作为IP有效载荷承载的，就像TCP与UDP报文段作为IP有效载荷被承载一样。ICMP使用IP的基本支持，就像它是一个更高级别的协议，但是，ICMP实际上是IP的一个组成部分，必须由每个IP模块实现。
>
> ICMP是源抑制报文，这种报文在实践中很少使用。其最初的目的是执行拥塞控制，即使得拥塞的路由器向一台主机发送一个ICMP源抑制报文，以强制该主机减小其发送速率
>
> ![在这里插入图片描述](https://img-blog.csdnimg.cn/2020082018162920.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzU0MTA5NA==,size_16,color_FFFFFF,t_70#pic_center)
>
> ICMP协议是一种面向无连接的协议，用于传输出错报告控制信息。它是一个非常重要的协议，它对于网络安全具有极其重要的意义。它属于网络层协议，主要用于在主机与路由器之间传递控制信息，包括报告错误、交换受限控制和状态信息等。当遇到IP数据无法访问目标、IP路由器无法按当前的传输速率转发数据包等情况时，会自动发送ICMP消息。
> ICMP 是 TCP/IP 模型中网络层的重要成员，与 IP 协议、ARP 协议、RARP 协议及 IGMP 协议共同构成 TCP/IP 模型中的网络层。ping 和 tracert是两个常用网络管理命令，ping 用来测试网络可达性，tracert 用来显示到达目的主机的路径。ping和 tracert 都利用 ICMP 协议来实现网络功能，它们是把网络协议应用到日常网络管理的典型实例。 
> 从技术角度来说，ICMP就是一个“错误侦测与回报机制”，其目的就是让我们能够检测网路的连线状况╋也能确保连线的准确性。当路由器在处理一个数据包的过程中发生了意外，可以通过ICMP向数据包的源端报告有关事件。
>
> ### 1、原理
>
> ICMP提供一致易懂的出错报告信息。发送的出错报文返回到发送原数据的设备，因为只有发送设备才是出错报文的逻辑接受者。发送设备随后可根据ICMP报文确定发生错误的类型，并确定如何才能更好地重发失败的数据包。但是ICMP唯一的功能是报告问题而不是纠正错误，纠正错误的任务由发送方完成。
>
> 我们在网络中经常会使用到ICMP协议，比如我们经常使用的用于检查网络通不通的Ping命令（Linux和Windows中均有），这个“Ping”的过程实际上就是ICMP协议工作的过程。还有其他的网络命令如跟踪路由的Tracert命令也是基于ICMP协议的。
>
> ### 2、ICMP报文格式
>
> ICMP报文包含在IP数据报中，属于IP的一个用户，IP头部就在ICMP报文的前面，所以一个ICMP报文包括IP头部、ICMP头部和ICMP报文，IP头部的Protocol值为1就说明这是一个ICMP报文，ICMP头部中的类型（Type）域用于说明ICMP报文的作用及格式，此外还有一个代码（Code）域用于详细说明某种ICMP报文的类型，所有数据都在ICMP头部后面。

## 5.7 网络管理和SNMP

> 网络管理包括了硬件，软件和人类元素的设置，综合和协调，以监视，测试，轮询，配置，分析，评价和控制网络及网元资源，用合理的成本满足实时性，运营性能和服务质量的要求
>
> ## 5.7.1 网络管理框架
>
> **管理服务器**：管理服务器是一个应用程序，通常有人的参与，并运行在**网络运营中心 NOC**的集中式网络管理工作站上。它控制网络管理信息的收集，处理，分析，，显示。在这里发起控制网络行为的动作，人类管理员与网络设备打交道
>
> **被管设备**：位于被管理的网络中，被管设备可以是一台主机，路由器，交换机，中间盒，调制解调器或其它联网的设备。在一个被管设备中，有几个所谓的**被管对象**，这些被管对象是被管设备中硬件的实际部分(如，路由器的一个组件)和用于这些硬件及软件组件的配置参数
>
> **管理信息库 MIB**：一个被管设备中每个被管对象的关联信息收集在管理信息库。一个MIB对象可以是，一台主机接收到的UDP报文段的数量等
>
> **网络管理代理**：每个设备中都有网络管理代理，它是运行在被管设备中的一个进程，该进程与管理服务器通信，在管理服务器的命令和控制下在被管设备中采取本地动作
>
> **网络管理协议**：该协议运行在管理服务器和被管设备之间，允许管理服务器查询被管设备的状态，并经过其代理间接地在这些设备上采取行动。网络管理协议自己不能管理网络，恰恰相反，它为网络管理员提供了一种能力，使他们能够管理网络
>
> ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200820184208629.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzU0MTA5NA==,size_16,color_FFFFFF,t_70#pic_center)
>
> ## 5.7.2 简单网络管理协议
>
> **简单网络管理协议 SNMP**：SNMP是一个应用层协议，用于在管理服务器和代表管理服务器执行地代理之间传递网络管理控制和信息报文
>
> SNMP最常用的是请求响应模式，其中SNMP管理服务器向SNMP代理发送一个请求，代理接收到该请求后，执行某些动作，然后对该请求发送一个回答。通常用于查询，检索，或修改，设置与某被管理设备的MIB对象值
>
> SNMP第二种常用的是代理向管理服务器发送的一种非请求报文，该报文称为**陷阱报文**。陷阱报文用于通知管理服务器，一个异常情况已经导致了MIB对象值的改变

